<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <title>Routee</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="css/simple.css" rel="stylesheet">
    <style>
      html, body,#map-canvas {
        height: 100%;
        margin: 0px;
        padding-top: 25px;
      }
      .controls {
        margin-top:16px;
        border: 1px solid transparent;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: 32px;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      #pac-input {
        background-color: #fff;
        padding: 0 11px 0 13px;
        width: 400px;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        text-overflow: ellipsis;
      }

      #pac-input:focus {
        border-color: #4d90fe;
        margin-left: -1px;
        padding-left: 14px;  /* Regular padding-left + 1. */
        width: 401px;
      }

      .pac-container {
        font-family: Roboto;
      }

      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }

      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
}

    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script>
     var map;
     var centerOfMap = new google.maps.LatLng(14.56486, 120.99370);

     var geocoder;

     var startIsSet = false;
     var startLocation;
     var destinationLocation;
     var waypts = [];

     var currLetter = 65;
            

     var markers = [];

     var directionsDisplay;
     var directionsService = new google.maps.DirectionsService();
     function initialize() {
          directionsDisplay = new google.maps.DirectionsRenderer();
          geocoder = new google.maps.Geocoder();
          var mapInitialize = {
                    center: centerOfMap,
                    zoom: 15,
                    disableDoubleClickZoom: true,
                    mapTypeId: google.maps.MapTypeId.ROADMAP

                };
          map = new google.maps.Map(document.getElementById('map-canvas'), mapInitialize);

         
          directionsDisplay.setMap(map);
          directionsDisplay.setOptions( { suppressMarkers: true } );

          
          
           
           $.get("dbControl.php", function(data) {
                    $(data).find("marker").each(function() {

                        var type = $(this).attr('type');
                        var desc = '<p>' + $(this).attr('description') + '</p>';
                        var point = new google.maps.LatLng(parseFloat($(this).attr('lat')), parseFloat($(this).attr('lng')));

                        //Iterate through types of icons
                        add_marker(point, type, desc, true, false, false, "");
                    });
                });
                //Right Click to Drop a New Marker
                google.maps.event.addListener(map, 'rightclick', function(event) {
                    //form to be displayed with new marker
                    var Report_Form = '<p><div class="marker-edit">' +
                            '<form action="ajax-save.php" method="POST" name="SaveMarker" id="SaveMarker">' +
                            '<label for="pType"><span>Area Type :</span> <select name="pType" class="save-type"><option value="Accident">Accident</option><option value="Flood">Flood</option>' +
                            '<option value="Construction">Construction</option><option value="Heavy Traffic">Heavy Traffic</option></select></label>' +
                            '<label for="pDesc"><span>What Happened here ?</span><textarea name="pDesc" class="save-desc" placeholder="Enter Details" maxlength="200"></textarea></label>' +
                            '</form>' +
                            '</div></p><button name="save-marker" class="save-marker">Save Report!</button>';
                    //Drop a new Marker with our Edit Form 
                    //CHANGE LAST PARAM TO CHOSEN ICON
                    add_marker(event.latLng, 'Report Area', Report_Form, true, true, true, "");
                });
                
                var input = /** @type {HTMLInputElement} */(
                document.getElementById('pac-input'));

                var types = document.getElementById('type-selector');
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(types);

                var autocomplete = new google.maps.places.Autocomplete(input);
                autocomplete.bindTo('bounds', map);

                var infowindow = new google.maps.InfoWindow();
                var marker = new google.maps.Marker({
                  map: map
                });

                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                  infowindow.close();
                  marker.setVisible(false);
                  var place = autocomplete.getPlace();
                  if (!place.geometry) {
                    return;
                  }

                  // If the place has a geometry, then present it on a map.
                  if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                  } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                  }
                  marker.setIcon(/** @type {google.maps.Icon} */({
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(35, 35)
                  }));
                  marker.setPosition(place.geometry.location);
                  marker.setVisible(true);

                  var address = '';
                  if (place.address_components) {
                    address = [
                      (place.address_components[0] && place.address_components[0].short_name || ''),
                      (place.address_components[1] && place.address_components[1].short_name || ''),
                      (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                  }

                  infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
                  infowindow.open(map, marker);
                });

                // Sets a listener on a radio button to change the filter type on Places
                // Autocomplete.
                function setupClickListener(id, types) {
                  var radioButton = document.getElementById(id);
                  google.maps.event.addDomListener(radioButton, 'click', function() {
                    autocomplete.setTypes(types);
                  });
                }

                setupClickListener('changetype-all', []);
                setupClickListener('changetype-establishment', ['establishment']);
                setupClickListener('changetype-geocode', ['geocode']);
            }

            //------------------ADD MARKER FUNCTION---------------------------
            function add_marker(MapPos, MapTitle, MapDesc, InfoOpenDefault, DragAble, Removable, iconPath)
            {

                var marker = new google.maps.Marker({
                    position: MapPos,
                    map: map,
                    draggable: DragAble,
                    animation: google.maps.Animation.DROP,
                    title: "Map Report",
                    icon: iconPath
                });

                //Content structure of info Window for the Markers
                var contentString = $('<div class="marker-info-win">' +
                        '<div class="marker-inner-win"><span class="info-content">' +
                        '<h3 class="marker-heading">' + MapTitle + '</h3>' +
                        MapDesc +
                        '</span><button name="remove-marker" class="remove-marker" title="Remove Marker">Remove Marker</button>' +
                        '</div></div>');


                var markerinfowindow = new google.maps.InfoWindow();
                markerinfowindow.setContent(contentString[0]);

                var removeBtn = contentString.find('button.remove-marker')[0];
                var saveBtn = contentString.find('button.save-marker')[0];

                google.maps.event.addDomListener(removeBtn, "click", function(event) {
                    remove_marker(marker);
                });

                if (typeof saveBtn !== 'undefined')
                {
                    //add click listner to save marker button
                    google.maps.event.addDomListener(saveBtn, "click", function(event) {
                        var mReplace = contentString.find('span.info-content');
                        var mType = contentString.find('select.save-type')[0].value; //type of marker
                        var mDesc = contentString.find('textarea.save-desc')[0].value; //description input field value

                        if (mDesc === '')
                        {
                            alert("Please enter Description!");
                        } else {
                            save_marker(marker, mDesc, mType, mReplace);
                        }
                    });
                   

                    if (InfoOpenDefault)
                    {
                        markerinfowindow.open(map, marker);
                    }
                }
                
                 google.maps.event.addListener(marker, 'click', function() {
                        markerinfowindow.open(map, marker);
                    });


            }

            function placeMarker(location) {
                var image;

                if(startIsSet == true){

                    image = "images/markers/brown_Marker";
                    image = image.concat(String.fromCharCode(currLetter++));
                    image = image.concat(".png");
                    
                    var marker = new google.maps.Marker({
                        position: destinationLocation, 
                        map: map,
                        icon: image

                    });
                    startIsSet = false;

                } else {
                    image = "images/markers/blue_Marker";
                    image = image.concat(String.fromCharCode(currLetter));
                    image = image.concat(".png");
                    
                    var marker = new google.maps.Marker({
                        position: startLocation, 
                        map: map,
                        icon: image

                    });
                    startIsSet = true;
                }
                

               

                markers.push(marker);

            }

            //------------------SAVE MARKER TO DB FUNCTION---------------------------
            function save_marker(Marker, mDesc, mType, replaceWin)
            {
                //Save new marker using jQuery Ajax
                var mLatLang = Marker.getPosition().toUrlValue();
                var myData = {description: mDesc, latlang: mLatLang, type: mType};
                console.log(replaceWin);
                $.ajax({
                    type: "POST",
                    url: "dbControl.php",
                    data: myData,
                    success: function(data) {
                        replaceWin.html(data);
                        Marker.setDraggable(false);
                        // REPLACE ICON HERE
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError);
                    }
                });
            }

            //------------------REMOVE MARKER FUNCTION---------------------------
            function remove_marker(Marker)
            {
                if (Marker.getDraggable())
                {
                    Marker.setMap(null); //just remove new marker
                }
                else
                {
                    var mLatLang = Marker.getPosition().toUrlValue(); //get marker position
                    var myData = {del: 'true', latlang: mLatLang}; //post variables
                    $.ajax({
                        type: "POST",
                        url: "dbControl.php",
                        data: myData,
                        success: function(data) {
                            Marker.setMap(null);
                            alert(data);
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError); //throw any errors
                        }
                    });
                }
            }

            function routeAddress() {
                var source = document.getElementById("sourceTextBox").value;
                var destination = document.getElementById("destinationTextBox").value;
                geocoder.geocode( { 'address': source}, function(results, status) {
                  if (status == google.maps.GeocoderStatus.OK) {
                          startLocation = results[0].geometry.location;
                          placeMarker(startLocation);

                      geocoder.geocode( { 'address': destination}, function(results, status) {
                      if (status == google.maps.GeocoderStatus.OK) {
                                  destinationLocation = results[0].geometry.location;
                                  placeMarker(destinationLocation);
                                  var request = {
                                      origin: startLocation,
                                      destination: destinationLocation,
                                      waypoints: waypts,
                                      optimizeWaypoints: true,
                                      travelMode: google.maps.TravelMode.DRIVING
                                  };

                                  directionsService.route(request, function(response, status) {
                                        if (status == google.maps.DirectionsStatus.OK) {
                                            directionsDisplay.setDirections(response);
                                        }else
                                            alert("Routing failed!");
                                        
                                  });

                      }
                });

                  }
                });
   
          }

      google.maps.event.addDomListener(window, 'load', initialize);
      google.maps.event.addDomListener(window, "resize", function() {
                var center = map.getCenter();
                google.maps.event.trigger(map, "resize");
                map.setCenter(center);
      });
    

    </script>
    <style type="text/css">
            /* Marker Add form */
            .marker-edit label{display:block; margin-bottom: 8px;}
            .marker-edit label span {width: 200px;float: left;}
            .marker-edit label input, .marker-edit label select{height: 29px;}
            .marker-edit label textarea{height: 60px; }
            .marker-edit label input, .marker-edit label select, .marker-edit label textarea {width: 100%;margin:0px;padding-left: 5px; padding-right: 5px;border: 1px solid #DDD;border-radius: 3px;}

            /* Marker Info Window */
            h3.marker-heading{color: #585858;margin: 0px;padding: 0px;font: 25px "Trebuchet MS", Arial!important;border-bottom: 1px dotted #D8D8D8;}
            div.marker-info-win {margin-right: -20px;max-width: 300px;}
            div.marker-info-win p{padding: 0px;margin: 10px 0px 10px 0;}
            div.marker-inner-win{padding: 5px;}
            button.save-marker, button.remove-marker{border: none;background: rgba(0, 0, 0, 0);color: #00F;padding: 0px;text-decoration: underline;margin-right: 10px;cursor: pointer;}
        </style>
  </head>
  <body>

    <div class = "navbar navbar-default navbar-fixed-top">
      <div class = "container">
      <a href = "#" class = "navbar-brand">Routee</a>
      <button class = "navbar-toggle" data-toggle = "collapse" data-target = ".navHeaderCollapse">
        <span class = "icon-bar"></span>
        <span class = "icon-bar"></span>
        <span class = "icon-bar"></span>
      </button>
        <div class = "collapse navbar-collapse navHeaderCollapse">
          <ul class = "nav navbar-nav navbar-right">
            <form class="navbar-form navbar-left" role="search">
              <div class="form-group">
                <input id="sourceTextBox" type="text" class="form-control" placeholder="From where?">
                <input id="destinationTextBox" type="text" class="form-control" placeholder="To where?">
              </div>
              <button type="submit" onclick="routeAddress()" class="btn btn-default">Find it</button>
            </form>
          </ul>
        </div>
      </div>
    </div>

    <input id="pac-input" class="controls" type="text"
        placeholder="Enter a location">
    <div id="type-selector" class="controls">
      <input type="radio" name="type" id="changetype-all" checked="checked">
      <label for="changetype-all">All</label>

      <input type="radio" name="type" id="changetype-establishment">
      <label for="changetype-establishment">Establishments</label>

      <input type="radio" name="type" id="changetype-geocode">
      <label for="changetype-geocode">Geocodes</label>
    </div>
    <div id="map-canvas"></div>
    

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src = "js/bootstrap.js"></script>
   

  </body>
</html>